<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>SIMEC - Sistema de AlmacÃ©n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="logo">
        <div class="logo-icon">
          <span class="material-icons">inventory_2</span>
        </div>
        <div class="logo-text">
          <h1>SIMEC</h1>
          <p>Sistema de AlmacÃ©n</p>
        </div>
      </div>

      <nav class="nav">
        <button class="nav-btn activa" data-section="materiales">
          <span class="material-icons">warehouse</span>
          Materiales/Entradas
        </button>

        <button class="nav-btn" data-section="proyectos">
          <span class="material-icons">assignment</span>
          Alta de proyectos/Salida/Etapas
        </button>

        <button class="nav-btn" data-section="admin-almacen" id="btn-nav-admin-almacen" style="display:none;">
          <span class="material-icons">build</span>
          Admin AlmacÃ©n (Lotes)/Ajustar/Revisiones 
        </button>

        <button class="nav-btn" data-section="movimientos">
          <span class="material-icons">timeline</span>
          Movimientos
        </button>

        <button class="nav-btn" data-section="usuarios" id="btn-nav-usuarios" style="display:none;">
          <span class="material-icons">manage_accounts</span>
          Usuarios
        </button>
      </nav>

      <footer class="sidebar-footer">
        <small>SIMEC Â· Material Design UI</small>
      </footer>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main">

      <!-- HEADER -->
      <header class="main-header" style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <div>
          <h2>Panel de Control</h2>
          <p>GestiÃ³n de materiales, proyectos, etapas y movimientos.</p>
          <small id="user-badge" class="small"></small>
        </div>

        <button class="btn-secondary" type="button" id="btn-logout">
          <span class="material-icons">logout</span> Salir
        </button>
      </header>

      <!-- =============================
     SECCIÃ“N: MATERIALES
     ============================= -->
<section id="materiales" class="seccion activa">
  <div class="section-title">
    <h3>Materiales</h3>
    <p>Alta y consulta de materiales registrados.</p>
  </div>

  <div class="grid-2">

    <!-- Tabla materiales -->
    <div class="card">
      <div class="card-header" style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <h4>Lista de materiales</h4>

        <div style="display:flex; gap:10px;">
          <button class="btn-secondary" type="button" id="btn-export-materiales-excel" style="display:none;">
            Exportar Excel
          </button>
          <button class="btn-secondary" type="button" id="btn-export-materiales-pdf" style="display:none;">
            Exportar PDF
          </button>
        </div>
      </div>

      <!-- Buscador -->
      <div class="card-body">
        <div class="form-group" style="margin-bottom:12px;">
          <label>Buscar material</label>
          <input type="text" id="buscar-materiales" placeholder="CÃ³digo, nombre, proveedor, ticket..." />
        </div>

        <div class="table-wrapper">
          <table class="table" id="tabla-materiales">
            <thead>
              <tr>
                <th>CÃ³digo</th>
                <th>Nombre</th>
                <th>Stock</th>
                <th>UbicaciÃ³n</th>
                <th>Proveedor</th>
                <th>Ticket</th>
                <th>Protocolo</th>
                <th>Precio</th>
                <th>Creado por</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Form nuevo material -->
    <div class="card">
      <div class="card-header">
        <h4>Registrar nuevo material (solo admin)</h4>
        <p class="small">Todos los campos extra son opcionales (proveedor, ticket, protocolo, precio).</p>
      </div>

      <div class="card-body">
        <form id="form-material" class="form">

          <div class="form-group">
            <label>CÃ³digo *</label>
            <input type="text" name="codigo" required />
          </div>

          <div class="form-group">
            <label>Nombre *</label>
            <input type="text" name="nombre" required />
          </div>

          <div class="form-group">
            <label>Stock inicial</label>
            <input type="number" name="stock_inicial" step="0.01" />
          </div>

          <div class="form-group">
            <label>Stock mÃ­nimo</label>
            <input type="number" name="stock_minimo" step="0.01" />
          </div>

          <div class="form-group">
            <label>UbicaciÃ³n</label>
            <input type="text" name="ubicacion" />
          </div>

          <hr class="divider">

          <div class="form-group">
            <label>Proveedor (opcional)</label>
            <select id="select-proveedor-material" name="proveedor_id">
              <option value="">â€”</option>
            </select>

            <small class="small">Si no existe, registra uno nuevo:</small>
            <div style="display:flex; gap:8px; margin-top:6px;">
              <input type="text" id="nuevo-proveedor-nombre" placeholder="Nombre proveedor" />
              <button class="btn-secondary" type="button" id="btn-crear-proveedor">Agregar</button>
            </div>
          </div>

          <div class="form-group">
            <label>NÃºmero de ticket (opcional)</label>
            <input type="text" name="ticket_numero" />
          </div>

          <div class="form-group">
            <label>Â¿Requiere protocolo? (opcional)</label>
            <select name="requiere_protocolo" id="select-requiere-protocolo">
              <option value="0">No</option>
              <option value="1">SÃ­</option>
            </select>
          </div>

          <div class="form-group" id="grupo-protocolo-texto" style="display:none;">
            <label>Protocolo (texto)</label>
            <input type="text" name="protocolo_texto" placeholder="Ej: PROT-123 / Instrucciones..." />
          </div>

          <div class="form-group">
            <label>Precio unitario (opcional)</label>
            <input type="number" name="precio_unitario" step="0.01" />
          </div>

          <button class="btn-primary" type="submit" id="btn-guardar-material" disabled>
            <span class="material-icons">save</span> Guardar
          </button>

          <p class="hint" id="hint-material-admin" style="margin-top:8px;">
            Solo admin puede crear materiales.
          </p>
        </form>
      </div>
    </div>

  </div>
</section>

       
      <!-- =============================
           SECCIÃ“N: PROYECTOS + ETAPAS
           ============================= -->
      <section id="proyectos" class="seccion">
        <div class="section-title">
          <h3>Proyectos</h3>
          <p>GestiÃ³n de proyectos, etapas y salidas de material.</p>
        </div>

        <div class="grid-2">

          <!-- Lista de proyectos -->
          <div class="card">
            <div class="card-header">
              <h4>Proyectos registrados</h4>
              <p class="small">Cada proyecto tiene export Excel/PDF (todo el proyecto).</p>
            </div>

            <div class="card-body">
              <ul id="lista-proyectos" class="list"></ul>
            </div>
             <label style="display:flex; gap:8px; align-items:center; margin:8px 0;">
            <input type="checkbox" id="toggle-ver-archivados" />
               Ver archivados
           </label>


            <div class="card-footer">
              <h4>Nuevo Proyecto (solo admin)</h4>

              <form id="form-proyecto" class="form">
                <div class="form-group">
                  <label>Clave *</label>
                  <input type="text" name="clave" required />
                </div>

                <div class="form-group">
                  <label>Nombre *</label>
                  <input type="text" name="nombre" required />
                </div>

                <div class="form-group">
                  <label>Cliente</label>
                  <input type="text" name="cliente" />
                </div>

                <div class="form-group">
                  <label>Fecha inicio</label>
                  <input type="date" name="fecha_inicio" />
                </div>

                <div class="form-group">
                  <label>DescripciÃ³n</label>
                  <textarea name="descripcion" rows="2"></textarea>
                </div>

                <button class="btn-primary" type="submit" id="btn-crear-proyecto" disabled>
                  <span class="material-icons">add_circle</span>
                  Crear Proyecto
                </button>

                <p class="hint" id="hint-proyecto-admin" style="margin-top:8px;">
                  Solo admin puede crear proyectos.
                </p>
              </form>
            </div>
          </div>

          <!-- Materiales asignados + ETAPAS -->
          <div class="card">
            <div class="card-header">
              <h4>Materiales del proyecto</h4>
              <p class="small">Proyecto seleccionado: <span id="info-proyecto-seleccionado">Ninguno</span></p>
            </div>

            <!-- ETAPAS -->
            <div class="card-body">
              <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
                <strong>Etapa activa:</strong> <span id="etapa-activa-texto">â€”</span>

                <button class="btn-secondary" type="button" id="btn-crear-etapa" style="display:none;">
                  Crear etapa
                </button>

                <button class="btn-secondary" type="button" id="btn-cerrar-etapa" style="display:none;">
                  Cerrar etapa
                </button>

                <div style="display:flex; gap:8px; align-items:center; margin-left:auto;">
                  <label class="small">Ver etapa:</label>
                  <select id="select-etapa">
                    <option value="__ALL__">Todas</option>
                  </select>

                  <button class="btn-secondary" type="button" id="btn-export-etapa-excel" style="display:none;">
                    Excel etapa
                  </button>

                  <button class="btn-secondary" type="button" id="btn-export-etapa-pdf" style="display:none;">
                    PDF etapa
                  </button>
                </div>
              </div>

              <div class="small" id="etapas-resumen" style="margin-top:8px;"></div>

              <div class="small" style="margin-top:8px;">
                Total etapa: <strong id="total-etapa">$0.00</strong> Â·
                Total proyecto: <strong id="total-proyecto">$0.00</strong>
              </div>
            </div>

            <div class="card-body">
              <form id="form-salida-proyecto" class="form form-inline">
                <div class="form-group">
                  <label>Buscar material</label>
                  <input type="text" id="buscar-material-proyecto" placeholder="Escribe cÃ³digo o nombre..." />
                </div>

                <div class="form-group">
                  <label>Material</label>
                  <select id="select-material-proyecto" name="material_id"></select>
                </div>

                <div class="form-group">
                  <label>Cantidad</label>
                  <input type="number" step="0.01" name="cantidad" required />
                </div>

                <div class="form-group">
                  <label>Comentario</label>
                  <input type="text" name="comentario" />
                </div>

                <button class="btn-primary" type="submit" id="btn-salida-proyecto" disabled>
                  <span class="material-icons">send</span>
                  Registrar salida (solo admin)
                </button>

                <p class="hint" id="hint-salida-admin" style="margin-top:8px;">
                  Solo admin puede registrar salidas a proyectos.
                </p>
              </form>
            </div>

            <div class="card-body table-wrapper">
              <table class="table" id="tabla-movimientos-proyecto">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Material</th>
                    <th>Tipo</th>
                    <th>Cantidad</th>
                    <th>Comentario</th>
                    <th>Usuario</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

          </div>

        </div>
      </section>

      <!-- =============================
           SECCIÃ“N: ADMIN ALMACÃ‰N (LOTES)
           ============================= -->
      <section id="admin-almacen" class="seccion">
        <div class="section-title">
          <h3>Admin de AlmacÃ©n (solo admin)</h3>
          <p>Editar material sin lotes + control por lotes (proveedor/precio) + ajustes.</p>
        </div>

        <div class="grid-2">

          
          <div class="card">
            <div class="card-header">
              <h4>Materiales</h4>
              <p class="small">Selecciona uno para editar material y administrar lotes.</p>
            </div>

            <div class="card-body">
              <div class="form-group" style="margin-bottom:12px;">
                <label>Buscar material</label>
                <input type="text" id="buscar-admin-material" placeholder="CÃ³digo o nombre..." />
              </div>

              <div class="table-wrapper">
                <table class="table" id="tabla-admin-materiales">
                  <thead>
                    <tr>
                      <th>CÃ³digo</th>
                      <th>Nombre</th>
                      <th>Stock</th>
                      <th>UbicaciÃ³n</th>
                      <th>AcciÃ³n</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>

            </div>
          </div>

          
          <div class="card">
            <div class="card-header">
              <h4>Detalle</h4>
              <p class="small">Material seleccionado: <span id="admin-material-seleccionado">Ninguno</span></p>
            </div>

            <div class="card-body" id="admin-panel" style="display:none;">

             
              <h4>Editar material (sin lotes)</h4>
              <form id="form-editar-material-base" class="form">
                <div class="form-group">
                  <label>Nombre *</label>
                  <input type="text" name="nombre" required />
                </div>

                
                <div class="form-group">
                  <label>Stock mÃ­nimo</label>
                  <input type="number" name="stock_minimo" step="0.01" />
                </div>

                <div class="form-group">
                 <label>Nombre de Lote (opcional)</label>
                  <input type="text" name="nombre_lote" placeholder="Ej: COMPRA-ENE-2026 / INICIAL..." />
                  <small class="small">Si lo dejas vacÃ­o, se crearÃ¡ automÃ¡ticamente INICIAL-CÃ“DIGO.</small>
                </div>

                <div class="form-group">  
                  <label>CÃ³digo *</label>
                  <input type="text" name="codigo" placeholder="(opcional)" />
                </div>

                <div class="form-group">
                  <label>UbicaciÃ³n</label>
                  <input type="text" name="ubicacion" />
                </div>

                <button class="btn-primary" type="submit">
                  <span class="material-icons">save</span> Guardar material
                </button>
              </form>

              <hr class="divider">

             
              <h4>Lotes</h4>
              <div class="table-wrapper" style="margin-bottom:14px;">
                <table class="table" id="tabla-admin-lotes">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Lote</th>
                      <th>Proveedor</th>
                      <th>Precio</th>
                      <th>Ticket</th>
                      <th>Protocolo</th>
                      <th>Inicial</th>
                      <th>Disponible</th>
                      <th>AcciÃ³n</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>

            
              <div id="panel-editar-lote" style="display:none;">
                <hr class="divider">
                <h4>Editar lote</h4>

                <form id="form-editar-lote" class="form">
                  <div class="form-group">
                    <label>Nombre de lote *</label>
                    <input type="text" name="nombre_lote" required />
                  </div>

                  <div class="form-group">
                    <label>Proveedor</label>
                    <select id="select-proveedor-editar-lote" name="proveedor_id">
                      <option value="">â€”</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label>Precio unitario</label>
                    <input type="number" step="0.01" name="precio_unitario" />
                  </div>

                  <div class="form-group">
                    <label>Ticket</label>
                    <input type="text" name="ticket_numero" />
                  </div>

                  <div class="form-group">
                    <label>Â¿Requiere protocolo?</label>
                    <select id="select-editar-lote-requiere-protocolo" name="requiere_protocolo">
                      <option value="0">No</option>
                      <option value="1">SÃ­</option>
                    </select>
                  </div>

                  <div class="form-group" id="grupo-editar-lote-protocolo" style="display:none;">
                    <label>Protocolo</label>
                    <input type="text" name="protocolo_texto" />
                  </div>

                  <div style="display:flex; gap:10px; align-items:center;">
                    <button class="btn-primary" type="submit">
                      <span class="material-icons">save</span> Guardar lote
                    </button>
                    <button class="btn-secondary" type="button" id="btn-cancelar-editar-lote">
                      Cancelar
                    </button>
                  </div>
                </form>
              </div>

              <hr class="divider">

              <h4>Agregar lote (compra nueva)</h4>
<form id="form-crear-lote" class="form">

  <!-- NUEVO: lote_codigo requerido por backend -->
  <div class="form-group">
    <label>Lote / CÃ³digo de lote *</label>
    <input type="text" name="lote_codigo" placeholder="Ej: LOTE-001 / Factura-123" required />
  </div>

  <div class="form-group">
    <label>Proveedor</label>
    <select id="select-proveedor-lote" name="proveedor_id">
      <option value="">â€”</option>
    </select>

    <!-- âœ… NUEVO: crear proveedor aquÃ­ tambiÃ©n -->
    <small class="small">Si no existe, crea uno:</small>
    <div style="display:flex; gap:8px; margin-top:6px;">
      <input type="text" id="nuevo-proveedor-nombre-lote" placeholder="Nombre proveedor" />
      <button class="btn-secondary" type="button" id="btn-crear-proveedor-lote">Agregar</button>
    </div>
  </div>

  <div class="form-group">
    <label>Precio unitario</label>
    <input type="number" step="0.01" name="precio_unitario" />
  </div>

  <div class="form-group">
    <label>Ticket</label>
    <input type="text" name="ticket_numero" />
  </div>

  <div class="form-group">
    <label>Â¿Requiere protocolo?</label>
    <select id="select-lote-requiere-protocolo" name="requiere_protocolo">
      <option value="0">No</option>
      <option value="1">SÃ­</option>
    </select>
  </div>

  <div class="form-group" id="grupo-lote-protocolo" style="display:none;">
    <label>Protocolo</label>
    <input type="text" name="protocolo_texto" />
  </div>

  <div class="form-group">
    <label>Cantidad a ingresar *</label>
    <input type="number" step="0.01" name="cantidad" required />
  </div>

  <button class="btn-primary" type="submit">
    <span class="material-icons">add</span> Crear lote y sumar stock
  </button>
</form>

<hr class="divider">

<h4>Ajustar lote (correcciÃ³n sin crear lote)</h4>
<form id="form-ajustar-lote" class="form form-inline">
  <div class="form-group">
    <label>Lote</label>
    <select id="select-ajuste-lote" name="lote_id"></select>
  </div>

  <div class="form-group">
    <label>Tipo</label>
    <select name="tipo">
            <option value="entrada">Sumar</option>
            <option value="salida">Restar</option>
            </select>
            </div>

           <div class="form-group">
           <label>Cantidad *</label>
             <input type="number" step="0.01" name="cantidad" required />
             </div>

              <div class="form-group">
            <label>Comentario</label>
              <input type="text" name="comentario" />
              </div>

              <button class="btn-secondary" type="submit">
             <span class="material-icons">tune</span> Aplicar ajuste
              </button>
              </form>

              <hr class="divider">

              <button class="btn-secondary" type="button" id="btn-desactivar-material">
                ðŸ—‘ Desactivar material
              </button>

            </div>

            <div class="card-body" id="admin-panel-vacio">
              <p class="hint">Selecciona un material para ver/editar y administrar lotes.</p>
            </div>

          </div>
        </div>
      </section>

      <!-- =============================
           SECCIÃ“N: MOVIMIENTOS
           ============================= -->
      <section id="movimientos" class="seccion">
        <div class="section-title">
          <h3>Movimientos</h3>
          <p>Historial global de entradas y salidas.</p>
        </div>

        <div class="card">
          <div class="card-header">
            <h4>Historial</h4>
          </div>

          <div class="card-body table-wrapper">
            <table class="table" id="tabla-movimientos-global">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Material</th>
                  <th>Proyecto</th>
                  <th>Etapa</th>
                  <th>Tipo</th>
                  <th>Cantidad</th>
                  <th>Comentario</th>
                  <th>Usuario</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- =============================
           SECCIÃ“N: USUARIOS (ADMIN)
           ============================= -->
      <section id="usuarios" class="seccion">
        <div class="section-title">
          <h3>Usuarios (solo admin)</h3>
          <p>Crear y listar usuarios.</p>
        </div>

        <div class="grid-2">
          <div class="card">
            <div class="card-header">
              <h4>Lista de usuarios</h4>
            </div>

            <div class="card-body table-wrapper">
              <table class="table" id="tabla-usuarios">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>Rol</th>
                    <th>Activo</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="card-footer">
              <button class="btn-secondary" type="button" id="btn-recargar-usuarios">Recargar</button>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h4>Crear usuario</h4>
            </div>

            <div class="card-body">
              <form id="form-usuario" class="form">
                <div class="form-group">
                  <label>Nombre *</label>
                  <input type="text" name="nombre" required />
                </div>

                <div class="form-group">
                  <label>Email *</label>
                  <input type="email" name="email" required />
                </div>

                <div class="form-group">
                  <label>ContraseÃ±a *</label>
                  <input type="password" name="password" required />
                </div>

                <div class="form-group">
                  <label>Rol *</label>
                  <select name="rol" required>
                    <option value="user">user</option>
                    <option value="admin">admin</option>
                  </select>
                </div>

                <button class="btn-primary" type="submit">
                  <span class="material-icons">person_add</span>
                  Crear usuario
                </button>
              </form>
            </div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <script src="script.js"></script>
</body>
</html>
